<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Splitwiser Pro</title>
    <style>
        /* BASE STYLES */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        h2 { margin-top: 0; font-size: 1.1rem; margin-bottom: 15px; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* INPUTS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e1e1e1; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        input:focus, select:focus { outline: none; border-color: #007bff; background: white; }
        
        /* CHECKBOX LIST */
        .user-checkbox-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-bottom: 15px; }
        .user-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .user-row:last-child { border-bottom: none; }
        .user-row label { flex-grow: 1; margin-left: 10px; font-weight: 500; }
        .amount-input { width: 80px; padding: 6px; margin: 0; display: none; border: 1px solid #ddd; border-radius: 4px; }
        
        /* BUTTONS */
        button { width: 100%; padding: 14px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .delete-btn { background: #ff4757; width: auto; padding: 5px 10px; font-size: 12px; border-radius: 6px; margin-left: 10px;}
        
        /* TABS for Split Type */
        .split-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .split-tab { flex: 1; padding: 10px; text-align: center; background: #eee; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 500; }
        .split-tab.active { background: #007bff; color: white; }

        /* UTILS */
        .status-msg { text-align: center; font-size: 0.85rem; margin-bottom: 15px; height: 20px; color: #888; font-weight: 500; }
        .owes-you { color: #27ae60; font-weight: 700; }
        .you-owe { color: #c0392b; font-weight: 700; }
        .list-item { border-bottom: 1px solid #f0f0f0; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div style="background: #2d3436; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
        <label style="font-size: 0.8em; text-transform: uppercase; opacity: 0.7;">ðŸ‘¤ Viewing As:</label>
        <select id="currentUserSelect" onchange="renderDashboard()" style="background: #454d50; color: white; border: none; margin-top: 5px;">
            <option value="">Loading...</option>
        </select>
    </div>

    <div id="statusMsg" class="status-msg">Connecting...</div>

    <div class="card">
        <h2>ðŸ’¸ Add Group Expense</h2>
        
        <input type="text" id="desc" placeholder="Description (e.g. Group Dinner)">
        
        <label style="font-size: 0.8em; color: #666;">Who Paid?</label>
        <select id="payerSelect"><option>Loading...</option></select>
        
        <label style="font-size: 0.8em; color: #666; margin-top: 10px; display:block;">Total Bill Amount:</label>
        <input type="number" id="totalAmount" placeholder="e.g. 1500" oninput="recalculateSplits()">

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <label style="font-size: 0.8em; color: #666;">How to Split?</label>
        <div class="split-tabs">
            <div class="split-tab active" id="tabEqual" onclick="setSplitType('equal')">Split Equally</div>
            <div class="split-tab" id="tabCustom" onclick="setSplitType('custom')">Custom Amounts</div>
        </div>

        <label style="font-size: 0.8em; color: #666; margin-bottom: 5px; display:block;">Who is involved? (Check them)</label>
        <div id="userCheckboxList" class="user-checkbox-list"></div>
        
        <div id="mathSummary" style="text-align: right; font-size: 0.85em; color: #666; margin-bottom: 10px; height: 20px;"></div>

        <button onclick="addExpense()" id="expBtn">Add Expense</button>
    </div>

    <div class="card">
        <h2 id="dashboardTitle">ðŸ“Š Dashboard</h2>
        <div id="statusList"></div>
    </div>

    <div class="card">
        <h2>ðŸ‘¥ Add Person</h2>
        <div style="display:flex; gap:10px;">
            <input type="text" id="newUserName" placeholder="Name">
            <button onclick="addUser()" style="width: 80px; margin-top:8px;">Add</button>
        </div>
    </div>

    <div class="card">
        <h2>ðŸ“œ History</h2>
        <div id="expenseList"></div>
    </div>

    <script>
        // ******************************************************
        // ðŸ‘‡ YOUR LINK IS NOW PRE-FILLED BELOW ðŸ‘‡
        const API_URL = "https://script.google.com/macros/s/AKfycbzvRULeMdsE8tJP-LcEZuTtCprwODIGAEkZKG_F0eXF-yhokMQ-41WHdGBReCJ4-MCi/exec"; 
        // ******************************************************
        
        let users = [];
        let expenses = [];
        let currentSplitType = 'equal'; // 'equal' or 'custom'

        // --- CORE SYNC FUNCTIONS ---
        async function loadFromCloud() {
            showStatus("â³ Syncing...");
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                users = data.users || [];
                expenses = data.expenses || [];
                renderAll();
                showStatus("âœ… Updated");
            } catch (error) {
                console.error(error);
                showStatus("âŒ Connection Failed");
            }
        }

        async function saveToCloud() {
            showStatus("ðŸ’¾ Saving...");
            const payload = JSON.stringify({ users, expenses });
            await fetch(API_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: payload });
            setTimeout(loadFromCloud, 1500);
        }

        function showStatus(msg) { document.getElementById('statusMsg').innerText = msg; }

        // --- NEW SPLIT LOGIC ---

        function setSplitType(type) {
            currentSplitType = type;
            document.getElementById('tabEqual').className = type === 'equal' ? 'split-tab active' : 'split-tab';
            document.getElementById('tabCustom').className = type === 'custom' ? 'split-tab active' : 'split-tab';
            
            // Show/Hide Input boxes based on type
            const inputs = document.querySelectorAll('.amount-input');
            inputs.forEach(input => {
                input.style.display = type === 'custom' ? 'block' : 'none';
            });
            recalculateSplits();
        }

        function recalculateSplits() {
            if (currentSplitType === 'custom') return; 

            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const checkboxes = document.querySelectorAll('.user-cb:checked');
            const count = checkboxes.length;
            
            if (count > 0) {
                const share = (total / count).toFixed(2);
                document.getElementById('mathSummary').innerText = `Total: ${total} Ã· ${count} people = â‚¹${share} each`;
            } else {
                document.getElementById('mathSummary').innerText = '';
            }
        }

        function addExpense() {
            const desc = document.getElementById('desc').value;
            const total = parseFloat(document.getElementById('totalAmount').value);
            const payer = document.getElementById('payerSelect').value;
            const checkboxes = document.querySelectorAll('.user-cb:checked');

            // Validation
            if (!desc || !total || payer === "Loading..." || checkboxes.length === 0) {
                alert("Please fill description, amount, payer, and select at least one person involved.");
                return;
            }

            // --- THE GHOST WRITER LOGIC ---
            
            let count = checkboxes.length;
            let equalShare = total / count;
            let entriesAdded = 0;

            checkboxes.forEach(cb => {
                const beneficiary = cb.value;
                
                // You don't owe yourself
                if (beneficiary === payer) return;

                let amountOwed = 0;
                
                if (currentSplitType === 'equal') {
                    amountOwed = equalShare;
                } else {
                    // Custom Amount: Read from the input box next to the checkbox
                    const inputId = `amt-${beneficiary}`;
                    amountOwed = parseFloat(document.getElementById(inputId).value) || 0;
                }

                if (amountOwed > 0) {
                    expenses.push({
                        id: Date.now() + Math.random(), 
                        desc: `${desc} (Split)`,
                        amount: amountOwed,
                        payer: payer,
                        beneficiary: beneficiary
                    });
                    entriesAdded++;
                }
            });

            if (entriesAdded === 0 && checkboxes.length > 0) {
                // If I paid for myself only, no debt is created, but that's okay.
                // We just alert so the user knows.
            }

            // Reset and Save
            document.getElementById('desc').value = '';
            document.getElementById('totalAmount').value = '';
            document.querySelectorAll('.user-cb').forEach(cb => cb.checked = false);
            saveToCloud();
        }

        // --- RENDERING UI ---

        function renderAll() {
            updateUserLists();
            renderDashboard();
            renderHistory();
        }

        function updateUserLists() {
            // 1. Perspective Dropdown
            const currentUser = document.getElementById('currentUserSelect').value;
            const options = users.map(u => `<option value="${u}">${u}</option>`).join('');
            
            document.getElementById('currentUserSelect').innerHTML = `<option value="">-- Select Your Name --</option>` + options;
            if(currentUser) document.getElementById('currentUserSelect').value = currentUser;

            // 2. Payer Dropdown
            const currentPayer = document.getElementById('payerSelect').value;
            document.getElementById('payerSelect').innerHTML = `<option value="">-- Select Payer --</option>` + options;
            if(currentPayer) document.getElementById('payerSelect').value = currentPayer;

            // 3. THE CHECKBOX LIST 
            const listContainer = document.getElementById('userCheckboxList');
            // We only rebuild if user count changed to keep checkbox state
            if (listContainer.children.length !== users.length) {
                listContainer.innerHTML = users.map(u => `
                    <div class="user-row">
                        <input type="checkbox" class="user-cb" value="${u}" onchange="recalculateSplits()">
                        <label>${u}</label>
                        <input type="number" class="amount-input" id="amt-${u}" placeholder="Amt">
                    </div>
                `).join('');
            }
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            if (name && !users.includes(name)) {
                users.push(name);
                document.getElementById('newUserName').value = '';
                saveToCloud();
            }
        }

        function deleteExpense(id) {
            if(confirm("Delete this entry?")) {
                expenses = expenses.filter(e => e.id !== id);
                saveToCloud();
            }
        }

        function renderDashboard() {
            const me = document.getElementById('currentUserSelect').value;
            const list = document.getElementById('statusList');
            const title = document.getElementById('dashboardTitle');
            list.innerHTML = '';
            
            if (!me) {
                title.innerText = "ðŸ“Š Dashboard";
                list.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">Select your name at the top first.</div>';
                return;
            }

            title.innerText = `Summary for ${me}`;
            let balances = {};
            users.forEach(u => balances[u] = 0);

            expenses.forEach(e => {
                if (e.payer === me) balances[e.beneficiary] += e.amount;
                else if (e.beneficiary === me) balances[e.payer] -= e.amount;
            });

            let html = '';
            for (let person in balances) {
                if (person === me) continue;
                const amt = balances[person];
                if (amt > 0.5) html += `<div class="list-item"><span class="owes-you">${person} owes you</span> <span class="owes-you">â‚¹${amt.toFixed(2)}</span></div>`;
                else if (amt < -0.5) html += `<div class="list-item"><span class="you-owe">You owe ${person}</span> <span class="you-owe">â‚¹${Math.abs(amt).toFixed(2)}</span></div>`;
            }
            if (!html) html = '<div style="text-align:center; color:#777;">All settled up! ðŸŽ‰</div>';
            list.innerHTML = html;
        }

        function renderHistory() {
            const list = document.getElementById('expenseList');
            if (expenses.length === 0) { list.innerHTML = '<div style="text-align:center;color:#ccc;">No expenses yet.</div>'; return; }
            list.innerHTML = expenses.map(e => `
                <div class="list-item">
                    <div>
                        <strong>${e.desc}</strong>
                        <div style="font-size:0.85em; color:#666;">${e.payer} paid for ${e.beneficiary} <span style="color:#000; font-weight:bold;">â‚¹${e.amount.toFixed(2)}</span></div>
                    </div>
                    <button class="delete-btn" onclick="deleteExpense(${e.id})">Del</button>
                </div>
            `).reverse().join('');
        }

        loadFromCloud();
    </script>
</body>
</html>
