<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Splitwiser v2</title>
    <style>
        /* BASE STYLES */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background: #f4f7f6; color: #333; }
        
        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        h2 { margin-top: 0; font-size: 1.1rem; margin-bottom: 15px; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* INPUTS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e1e1e1; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        input:focus, select:focus { outline: none; border-color: #007bff; background: white; }
        
        /* BUTTONS */
        button { width: 100%; padding: 14px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        /* DELETE BUTTON */
        .delete-btn { background: #ff4757; width: auto; padding: 6px 12px; font-size: 13px; border-radius: 6px; margin-top: 0; }
        
        /* LAYOUT HELPERS */
        .row { display: flex; gap: 10px; }
        .half { width: 50%; }
        
        /* PERSPECTIVE BAR (TOP) */
        .perspective-bar { background: #2d3436; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .perspective-bar label { font-size: 0.85rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .perspective-bar select { background: #454d50; color: white; border: none; margin-top: 5px; }
        
        /* STATUS */
        .status-msg { text-align: center; font-size: 0.85rem; margin-bottom: 15px; height: 20px; color: #888; font-weight: 500; }
        
        /* LIST ITEMS */
        .list-item { border-bottom: 1px solid #f0f0f0; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .desc-text { font-weight: 600; font-size: 1rem; }
        .sub-text { font-size: 0.85em; color: #888; margin-top: 4px; }
        
        /* MONEY COLORS */
        .owes-you { color: #27ae60; font-weight: 700; }
        .you-owe { color: #c0392b; font-weight: 700; }
        .amount { font-family: 'Courier New', monospace; letter-spacing: -0.5px; }
    </style>
</head>
<body>

    <div class="perspective-bar">
        <label>ðŸ‘¤ Viewing As:</label>
        <select id="currentUserSelect" onchange="renderDashboard()">
            <option value="">-- Loading... --</option>
        </select>
    </div>

    <div id="statusMsg" class="status-msg">Loading data...</div>

    <div class="card">
        <h2>ðŸ‘¥ Add New Person</h2>
        <div class="row">
            <input type="text" id="newUserName" placeholder="Name (e.g. Dad)">
            <button onclick="addUser()" id="addBtn" style="width: 80px;">Add</button>
        </div>
    </div>

    <div class="card">
        <h2>ðŸ’¸ Add Expense</h2>
        
        <input type="text" id="desc" placeholder="Description (e.g. Dinner)">
        
        <div class="row">
            <div class="half">
                <label style="font-size: 0.8em; color: #666; margin-left: 5px;">Total Bill â‚¹</label>
                <input type="number" id="totalAmount" placeholder="1000">
            </div>
            <div class="half">
                <label style="font-size: 0.8em; color: #666; margin-left: 5px;">Split Type</label>
                <select id="splitType">
                    <option value="0.5">Split Half (50%)</option>
                    <option value="1.0">Full Bill (100%)</option>
                    <option value="0.333">Split 1/3 (33%)</option>
                    <option value="0.25">Split 1/4 (25%)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <select id="payerSelect"><option>Who Paid?</option></select>
            <select id="beneficiarySelect"><option>Who Owes?</option></select>
        </div>
        
        <button onclick="addExpense()" id="expBtn">Add Expense</button>
    </div>

    <div class="card">
        <h2 id="dashboardTitle">ðŸ“Š Dashboard</h2>
        <div id="statusList"></div>
    </div>

    <div class="card">
        <h2>ðŸ“œ History</h2>
        <div id="expenseList"></div>
    </div>

    <script>
        // ******************************************************
        // ðŸ‘‡ PASTE YOUR GOOGLE SCRIPT URL INSIDE THE QUOTES ðŸ‘‡
        const API_URL = "https://script.google.com/macros/s/AKfycbzvRULeMdsE8tJP-LcEZuTtCprwODIGAEkZKG_F0eXF-yhokMQ-41WHdGBReCJ4-MCi/exec"; 
        // ******************************************************
        
        let users = [];
        let expenses = [];

        // --- CLOUD SYNC ---
        async function loadFromCloud() {
            showStatus("â³ Syncing...");
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                users = data.users || [];
                expenses = data.expenses || [];
                renderAll();
                showStatus("âœ… Updated");
            } catch (error) {
                console.error(error);
                showStatus("âŒ Connection Failed");
            }
        }

        async function saveToCloud() {
            showStatus("ðŸ’¾ Saving...");
            const payload = JSON.stringify({ users, expenses });
            await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: payload
            });
            setTimeout(loadFromCloud, 1500);
        }

        function showStatus(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        // --- APP LOGIC ---

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            if (name && !users.includes(name)) {
                users.push(name);
                document.getElementById('newUserName').value = '';
                saveToCloud();
            }
        }

        function addExpense() {
            // 1. Get Values
            const descRaw = document.getElementById('desc').value;
            const totalBill = parseFloat(document.getElementById('totalAmount').value);
            const splitFactor = parseFloat(document.getElementById('splitType').value);
            const payer = document.getElementById('payerSelect').value;
            const beneficiary = document.getElementById('beneficiarySelect').value;

            // 2. Validate
            if (!descRaw || !totalBill || payer === 'Who Paid?' || beneficiary === 'Who Owes?') {
                alert("Please fill in all fields!");
                return;
            }
            if (payer === beneficiary) {
                alert("Payer and Person Who Owes cannot be the same.");
                return;
            }

            // 3. Calculate DEBT (The magic part)
            // Example: Bill 1000, Split 50% -> Debt is 500.
            const debtAmount = totalBill * splitFactor;
            
            // Create a nice description like "Dinner (50%)"
            const percentage = (splitFactor * 100).toFixed(0) + "%";
            const finalDesc = `${descRaw} (${percentage})`;

            // 4. Save
            expenses.push({ 
                id: Date.now(), 
                desc: finalDesc, 
                amount: debtAmount, // We save the DEBT amount, not the total bill
                payer: payer, 
                beneficiary: beneficiary 
            });

            // 5. Reset Form
            document.getElementById('desc').value = '';
            document.getElementById('totalAmount').value = '';
            
            saveToCloud();
        }

        function deleteExpense(id) {
            if(confirm("Delete this expense?")) {
                expenses = expenses.filter(e => e.id !== id);
                saveToCloud();
            }
        }

        // --- RENDERING ---

        function renderAll() {
            updateDropdowns();
            renderDashboard();
            renderHistory();
        }

        function updateDropdowns() {
            const currentVal = document.getElementById('currentUserSelect').value;
            const makeOptions = (selected) => users.map(u => `<option value="${u}" ${u === selected ? 'selected' : ''}>${u}</option>`).join('');
            
            // Main Perspective Dropdown
            const userSelect = document.getElementById('currentUserSelect');
            if (users.length === 0) {
                userSelect.innerHTML = `<option value="">-- Add a person first --</option>`;
            } else {
                userSelect.innerHTML = `<option value="">-- Select Your Name --</option>` + makeOptions(currentVal);
            }

            // Expense Dropdowns
            document.getElementById('payerSelect').innerHTML = `<option>Who Paid?</option>` + makeOptions("");
            document.getElementById('beneficiarySelect').innerHTML = `<option>Who Owes?</option>` + makeOptions("");
        }

        function renderDashboard() {
            const me = document.getElementById('currentUserSelect').value;
            const list = document.getElementById('statusList');
            const title = document.getElementById('dashboardTitle');
            
            list.innerHTML = '';
            
            if (!me) {
                title.innerText = "ðŸ“Š Dashboard";
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Select your name at the top to see debts.</div>';
                return;
            }

            title.innerText = `ðŸ“Š Summary for ${me}`;
            
            let balances = {};
            users.forEach(u => balances[u] = 0);

            expenses.forEach(e => {
                if (e.payer === me) {
                    balances[e.beneficiary] += e.amount; // They owe me
                } else if (e.beneficiary === me) {
                    balances[e.payer] -= e.amount; // I owe them
                }
            });

            let html = '';
            for (let person in balances) {
                if (person === me) continue;
                const amt = balances[person];
                if (amt > 0.5) { // Show if debt is more than 50 cents
                    html += `<div class="list-item"><span class="owes-you">${person} owes you</span> <span class="owes-you amount">â‚¹${amt.toFixed(2)}</span></div>`;
                } else if (amt < -0.5) {
                    html += `<div class="list-item"><span class="you-owe">You owe ${person}</span> <span class="you-owe amount">â‚¹${Math.abs(amt).toFixed(2)}</span></div>`;
                }
            }
            
            if (html === '') html = '<div style="text-align:center; color:#777; padding:10px;">All settled up! ðŸŽ‰</div>';
            list.innerHTML = html;
        }

        function renderHistory() {
            const list = document.getElementById('expenseList');
            if (expenses.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">No expenses yet.</div>';
                return;
            }
            list.innerHTML = expenses.map(e => `
                <div class="list-item">
                    <div>
                        <div class="desc-text">${e.desc}</div>
                        <div class="sub-text">
                            ${e.payer} paid for ${e.beneficiary} <br>
                            <span style="color:#555; font-weight:bold;">Debt Created: â‚¹${e.amount.toFixed(2)}</span>
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteExpense(${e.id})">Del</button>
                </div>
            `).reverse().join('');
        }

        // START
        loadFromCloud();
    </script>
</body>
</html>
