<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Splitwiser Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN VARIABLES --- */
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-dark: #4338ca;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #111827;
            --text-light: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
            --border: #E5E7EB;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Space for scrolling */
        }

        /* --- APP HEADER --- */
        .app-header {
            background: var(--card-bg);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); letter-spacing: -0.5px; }
        .status-badge { font-size: 0.75rem; font-weight: 500; padding: 4px 8px; border-radius: 20px; background: #EEF2FF; color: var(--primary); }

        /* --- CONTAINER --- */
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card-title {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-light); margin-bottom: 6px; }
        
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: #F9FAFB;
            transition: all 0.2s;
            appearance: none; /* Removes default UI on iOS */
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .btn-primary:active { transform: scale(0.98); background: var(--primary-dark); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; width: auto; }
        .btn-delete { background: #FEF2F2; color: var(--danger); font-size: 0.8rem; padding: 6px 12px; border-radius: 8px; }

        /* --- SEGMENTED CONTROL (TABS) --- */
        .segmented-control {
            display: flex;
            background: #F3F4F6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .segment-opt {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .segment-opt.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 600;
        }

        /* --- USER LIST --- */
        .user-list {
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 250px;
            overflow-y: auto;
        }
        .user-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }
        .user-row:last-child { border-bottom: none; }
        .user-row:hover { background: #F9FAFB; }
        .checkbox-custom {
            width: 20px; height: 20px;
            margin-right: 12px;
            accent-color: var(--primary);
        }
        .user-name { flex-grow: 1; font-weight: 500; }
        .custom-amt-input {
            width: 90px;
            padding: 8px;
            font-size: 0.9rem;
            text-align: right;
            margin: 0;
            display: none;
        }

        /* --- DASHBOARD ITEMS --- */
        .dash-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }
        .dash-item:last-child { border-bottom: none; }
        .dash-text { font-size: 0.95rem; font-weight: 500; }
        .dash-amt { font-family: 'Inter', monospace; font-weight: 700; letter-spacing: -0.5px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* --- HISTORY ITEMS --- */
        .history-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        .history-main { display: flex; flex-direction: column; gap: 4px; }
        .hist-desc { font-weight: 600; color: var(--text-main); }
        .hist-meta { font-size: 0.85rem; color: var(--text-light); }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="app-logo">Splitwiser Pro</div>
        <div id="statusBadge" class="status-badge">Connecting...</div>
    </div>

    <div class="container">

        <div class="card" style="padding: 16px; background: #2d3436; color: white;">
            <label style="color: rgba(255,255,255,0.7); margin-bottom: 8px;">YOU ARE VIEWING AS:</label>
            <select id="currentUserSelect" onchange="renderDashboard()" style="background: rgba(255,255,255,0.1); border: none; color: white;">
                <option value="">Loading users...</option>
            </select>
        </div>

        <div class="card">
            <h3 class="card-title">ðŸ’¸ Add Expense</h3>
            
            <div class="form-group">
                <input type="text" id="desc" placeholder="What was it? (e.g. Dinner)">
            </div>
            
            <div class="form-group">
                <input type="number" id="totalAmount" placeholder="Total Amount (e.g. 1500)" oninput="recalculateSplits()">
            </div>

            <div class="form-group">
                <label>Who paid?</label>
                <select id="payerSelect" onchange="recalculateSplits()"><option>Loading...</option></select>
            </div>

            <div class="form-group">
                <label>Split Method</label>
                <div class="segmented-control">
                    <div class="segment-opt active" id="tabEqual" onclick="setSplitType('equal')">Equally</div>
                    <div class="segment-opt" id="tabCustom" onclick="setSplitType('custom')">Custom</div>
                </div>
            </div>

            <div class="form-group">
                <label>Who is involved?</label>
                <div id="userCheckboxList" class="user-list">
                    </div>
            </div>

            <div id="mathSummary" style="text-align: right; font-size: 0.85rem; color: var(--primary); font-weight: 600; margin-bottom: 15px; height: 20px;"></div>

            <button onclick="addExpense()" class="btn btn-primary" id="addExpBtn">Add Expense</button>
        </div>

        <div class="card">
            <h3 class="card-title">ðŸ“Š Dashboard</h3>
            <div id="statusList">
                <div style="text-align: center; color: var(--text-light); padding: 20px;">
                    Select your name at the top to see balances.
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">ðŸ‘¥ Add New Person</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newUserName" placeholder="Enter Name">
                <button onclick="addUser()" class="btn btn-primary btn-sm">Add</button>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">ðŸ“œ History</h3>
            <div id="expenseList">
                <div style="text-align: center; color: var(--text-light);">No transactions yet.</div>
            </div>
        </div>

    </div>

    <script>
        // ***************************************************************
        // âœ… LINK INSERTED BELOW
        const API_URL = "https://script.google.com/macros/s/AKfycbzvRULeMdsE8tJP-LcEZuTtCprwODIGAEkZKG_F0eXF-yhokMQ-41WHdGBReCJ4-MCi/exec"; 
        // ***************************************************************
        
        let users = [];
        let expenses = [];
        let currentSplitType = 'equal'; // 'equal' or 'custom'
        let isSaving = false;

        // --- CORE SYNC ---
        async function loadFromCloud() {
            updateStatus("Syncing...", "busy");
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                users = data.users || [];
                expenses = data.expenses || [];
                renderAll();
                updateStatus("Connected", "success");
            } catch (error) {
                console.error(error);
                updateStatus("Offline", "error");
            }
        }

        async function saveToCloud() {
            if (isSaving) return;
            isSaving = true;
            updateStatus("Saving...", "busy");
            
            const btn = document.getElementById('addExpBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const payload = JSON.stringify({ users, expenses });
            
            try {
                await fetch(API_URL, { 
                    method: "POST", 
                    mode: "no-cors", 
                    headers: { "Content-Type": "text/plain" }, 
                    body: payload 
                });
                
                setTimeout(() => {
                    loadFromCloud();
                    isSaving = false;
                    btn.innerText = "Add Expense";
                    btn.disabled = false;
                }, 1500);
            } catch (e) {
                updateStatus("Save Failed", "error");
                isSaving = false;
                btn.innerText = "Add Expense";
                btn.disabled = false;
            }
        }

        function updateStatus(msg, type) {
            const el = document.getElementById('statusBadge');
            el.innerText = msg;
            if (type === 'success') { el.style.background = '#D1FAE5'; el.style.color = '#065F46'; }
            else if (type === 'error') { el.style.background = '#FEE2E2'; el.style.color = '#991B1B'; }
            else { el.style.background = '#EEF2FF'; el.style.color = '#4F46E5'; }
        }

        // --- UI LOGIC ---

        function setSplitType(type) {
            currentSplitType = type;
            document.getElementById('tabEqual').className = type === 'equal' ? 'segment-opt active' : 'segment-opt';
            document.getElementById('tabCustom').className = type === 'custom' ? 'segment-opt active' : 'segment-opt';
            
            const inputs = document.querySelectorAll('.custom-amt-input');
            inputs.forEach(input => input.style.display = type === 'custom' ? 'block' : 'none');
            
            recalculateSplits();
        }

        function recalculateSplits() {
            if (currentSplitType === 'custom') {
                document.getElementById('mathSummary').innerText = "";
                return; 
            }

            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const checkboxes = document.querySelectorAll('.user-cb:checked');
            const count = checkboxes.length;
            
            if (count > 0 && total > 0) {
                const share = (total / count).toFixed(2);
                document.getElementById('mathSummary').innerText = `â‚¹${share} per person`;
            } else {
                document.getElementById('mathSummary').innerText = '';
            }
        }

        function addExpense() {
            const desc = document.getElementById('desc').value;
            const total = parseFloat(document.getElementById('totalAmount').value);
            const payer = document.getElementById('payerSelect').value;
            const checkboxes = document.querySelectorAll('.user-cb:checked');

            if (!desc || !total || payer === "Loading..." || checkboxes.length === 0) {
                alert("Please fill in all fields and select people.");
                return;
            }

            // GHOST WRITER LOGIC
            let count = checkboxes.length;
            let equalShare = total / count;
            let entriesAdded = 0;

            checkboxes.forEach(cb => {
                const beneficiary = cb.value;
                if (beneficiary === payer) return; // Skip self

                let amountOwed = 0;
                if (currentSplitType === 'equal') {
                    amountOwed = equalShare;
                } else {
                    const inputId = `amt-${beneficiary}`;
                    amountOwed = parseFloat(document.getElementById(inputId).value) || 0;
                }

                if (amountOwed > 0) {
                    expenses.push({
                        id: Date.now() + Math.random(), 
                        desc: `${desc} (Split)`,
                        amount: amountOwed,
                        payer: payer,
                        beneficiary: beneficiary,
                        date: new Date().toLocaleDateString()
                    });
                    entriesAdded++;
                }
            });

            // Reset UI
            document.getElementById('desc').value = '';
            document.getElementById('totalAmount').value = '';
            document.querySelectorAll('.user-cb').forEach(cb => cb.checked = false);
            document.getElementById('mathSummary').innerText = '';
            
            saveToCloud();
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            if (name && !users.includes(name)) {
                users.push(name);
                document.getElementById('newUserName').value = '';
                saveToCloud();
            }
        }

        function deleteExpense(id) {
            if(confirm("Delete this transaction?")) {
                expenses = expenses.filter(e => e.id !== id);
                saveToCloud();
            }
        }

        // --- RENDERERS ---

        function renderAll() {
            updateUserLists();
            renderDashboard();
            renderHistory();
        }

        function updateUserLists() {
            const currentUser = document.getElementById('currentUserSelect').value;
            const currentPayer = document.getElementById('payerSelect').value;
            
            const options = users.map(u => `<option value="${u}">${u}</option>`).join('');
            
            // Dropdowns
            const userSelect = document.getElementById('currentUserSelect');
            userSelect.innerHTML = `<option value="">-- Select Your Name --</option>` + options;
            if(currentUser) userSelect.value = currentUser;

            const payerSelect = document.getElementById('payerSelect');
            payerSelect.innerHTML = `<option value="">-- Select Payer --</option>` + options;
            if(currentPayer) payerSelect.value = currentPayer;

            // Checkbox List (Only rebuild if needed)
            const listContainer = document.getElementById('userCheckboxList');
            if (listContainer.children.length !== users.length) {
                listContainer.innerHTML = users.map(u => `
                    <div class="user-row">
                        <input type="checkbox" class="user-cb checkbox-custom" value="${u}" onchange="recalculateSplits()">
                        <span class="user-name">${u}</span>
                        <input type="number" class="custom-amt-input" id="amt-${u}" placeholder="0">
                    </div>
                `).join('');
            }
        }

        function renderDashboard() {
            const me = document.getElementById('currentUserSelect').value;
            const list = document.getElementById('statusList');
            
            if (!me) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Select your name at the top to see your dashboard.</div>';
                return;
            }

            let balances = {};
            users.forEach(u => balances[u] = 0);

            expenses.forEach(e => {
                if (e.payer === me) balances[e.beneficiary] += e.amount;
                else if (e.beneficiary === me) balances[e.payer] -= e.amount;
            });

            let html = '';
            let hasDebt = false;
            
            for (let person in balances) {
                if (person === me) continue;
                const amt = balances[person];
                if (Math.abs(amt) < 0.5) continue; // Skip tiny amounts

                hasDebt = true;
                if (amt > 0) {
                    html += `
                    <div class="dash-item">
                        <span class="dash-text">${person} owes you</span> 
                        <span class="dash-amt text-green">â‚¹${amt.toFixed(2)}</span>
                    </div>`;
                } else {
                    html += `
                    <div class="dash-item">
                        <span class="dash-text">You owe ${person}</span> 
                        <span class="dash-amt text-red">â‚¹${Math.abs(amt).toFixed(2)}</span>
                    </div>`;
                }
            }
            
            if (!hasDebt) html = '<div style="text-align:center; color:#10B981; padding:15px; font-weight:500;">You are all settled up! ðŸŽ‰</div>';
            list.innerHTML = html;
        }

        function renderHistory() {
            const list = document.getElementById('expenseList');
            if (expenses.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No expenses yet.</div>';
                return;
            }
            list.innerHTML = expenses.map(e => `
                <div class="history-item">
                    <div class="history-main">
                        <div class="hist-desc">${e.desc}</div>
                        <div class="hist-meta">${e.payer} paid for ${e.beneficiary}</div>
                        <div class="hist-meta" style="font-weight:600; color:var(--text-main);">â‚¹${e.amount.toFixed(2)}</div>
                    </div>
                    <button class="btn btn-delete" onclick="deleteExpense(${e.id})">Delete</button>
                </div>
            `).reverse().join('');
        }

        loadFromCloud();
    </script>
</body>
</html>
